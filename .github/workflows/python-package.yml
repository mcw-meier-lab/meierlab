# This workflow will install Python dependencies, run tests and lint with a variety of Python versions
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Meierlab Code Checks

on:
  push:
  pull_request:
    branches: [ "main" ]

env:
  FREESURFER_VERSION: 7.4.1
  FREESURFER_HOME: /opt/freesurfer
  DOWNLOADS_DIR: /downloads/freesurfer

jobs:
  test-python-versions:
    name: Check Python ${{ matrix.python-version }} on ${{ matrix.runs-on }}
    continue-on-error: ${{ matrix.allow_failure }}
    runs-on: ${{ matrix.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10","3.11","3.12"]
        allow_failure: [false]
        runs-on: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install package
      run: python -m pip install -e .[test]

    - name: Test with pytest
      env:
        ATLAS_FILE: ${{ github.workspace }}/tests/data/atlas.csv
        SUB_FILE: ${{ github.workspace }}/tests/data/sub-atlas.tsv
      run: python -m pytest

#NOTE: Runs out of space: probably needs a docker container
#  test-freesurfer:
#    name: Check FreeSurfer on Ubuntu
#    continue-on-error: ${{ matrix.allow_failure }}
#    runs-on: ubuntu-latest
#    strategy:
#      fail-fast: false
#      matrix:
#        python-version: ["3.10"]
#        allow_failure: [false]
#
#    steps:
#    - uses: actions/checkout@v4
#    - name: Set up Python ${{ matrix.python-version }}
#      uses: actions/setup-python@v5
#      with:
#        python-version: ${{ matrix.python-version }}
#
#    - name: Install package
#      run: python -m pip install -e .[test]
#
#    - name: Create installation directory
#      run: |
#        sudo mkdir -p $FREESURFER_HOME
#        sudo chown $USER $FREESURFER_HOME
#
#    - name: Download FreeSurfer
#      run: |
#        sudo mkdir -p $DOWNLOADS_DIR
#        sudo chown $USER $DOWNLOADS_DIR
#        curl -s -o $DOWNLOADS_DIR/freesurfer-linux-ubuntu22_amd64-${{ env.FREESURFER_VERSION }}.tar.gz https://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/${{ env.FREESURFER_VERSION }}/freesurfer-linux-ubuntu22_amd64-${{ env.FREESURFER_VERSION }}.tar.gz
#      shell: bash
#
#    - name: Install Freesurfer
#      env:
#        FREESURFER_LICENSE: ${{ secrets.FREESURFER_LICENSE }}
#      run: |
#        pushd $DOWNLOADS_DIR/
#        tar -zxpf freesurfer-linux-ubuntu22_amd64-${{ env.FREESURFER_VERSION }}.tar.gz
#        mv freesurfer/* ${{ env.FREESURFER_HOME }}
#        popd
#        source ${{ env.FREESURFER_HOME }}/SetUpFreeSurfer.sh
#        echo $FREESURFER_LICENSE > ${{ env.FREESURFER_HOME }}/license.txt
#        echo "PATH=${{ env.FREESURFER_HOME }}/bin:$PATH" >> $GITHUB_ENV
#
#    - name: Test FreeSurfer viz
#      run: |
#        python -m pytest tests/test_freesurfer.py
#
#    - name: Test FreeSurfer workflow
#      run: |
#        python -m pytest tests/test_workflow.py
